<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>A-pets</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link rel="stylesheet" href="style.css">
</head>
<body>

  <!-- <h1 id="titulo">Treine seu Agente</h1> -->

  <main>
    <div id="main" >
      <div id="simContainer">
        <!-- O canvas será criado e inserido aqui pelo p5.js -->
      </div>
      <label for="cor-corpo">Cor do corpo:</label>
      <input type="color" id="cor-corpo" name="cor-corpo">

      <label for="forma-corpo">Forma do corpo:</label>
      <select id="forma-corpo" name="forma-corpo">
      <option value="square">Quadrado</option>
      <option value="circle">Círculo</option>
      <option value="triangle">Triângulo</option>
      </select>

      <label for="cor-olhos">Cor dos olhos:</label>
      <input type="color" id="cor-olhos" name="cor-olhos">

      <label for="cor-boca">Cor da boca:</label>
      <input type="color" id="cor-boca" name="cor-boca">

      <br><br>
      <button onclick="criarAPet()">Criar</button>
    </div>
  </main>

  <!-- Scripts externos: carregam primeiro -->
  <script src="https://cdn.jsdelivr.net/pyodide/v0.25.1/full/pyodide.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>

  <!-- Seu código -->
  <script>
    async function init() {
      const pyodide = await loadPyodide();
      await pyodide.loadPackage("micropip")

      try {
        const code = `
import micropip
await micropip.install("behavioralflow")
import time
from behavioralflow.core import Aprendente

PASSOS_POR_SEGUNDO = 20  # 1 segundo = 20 passos (com loop de 0.05s)

WIDTH = 400
HEIGHT = 400

responses = {("cima",):[0,6],
             ("baixo",):[0,6],
             ("esq",):[0,6],
             ("dir",):[0,6],
             ("parado",):[0,6]}

class Agents(Aprendente):
    def __init__(self, acoes, variar=False, prob_variacao=0.25, positionX = 0, positionY = 0, angle = 0, color="#000000", name = "", shape = "square", eyeColor="black", mouthColor="black"):
        super().__init__(acoes, variar, prob_variacao)
        self.positionX = positionX
        self.positionY = positionY
        self.passos_restantes = 0
        self.color = color
        self.previousPositionX = positionX
        self.previousPositionY = positionY
        self.name = name
        self.antecedente_atual = ("sem contexto",)
        self.shape = shape
        self.eyeColor = eyeColor
        self.mouthColor = mouthColor
    
    #def set_context(self):
        #context = ("sem contexto",)
        #return context

    # Executa as ações
    def to_respond(self, context):
        if self.passos_restantes == 0:
            self.circle_color = "#FFFFFF"
            self.proxima_acao(context)
            self.passos_restantes = PASSOS_POR_SEGUNDO + (PASSOS_POR_SEGUNDO/2) # 1seg e meio por ação
            print(self._acao_atual)

        # Executa a ação atual
        if self._acao_atual[0] == "cima":
            self.positionY = (self.positionY - 1) % HEIGHT
        
        elif self._acao_atual[0] == "baixo":
            self.positionY = (self.positionY + 1) % HEIGHT
        
        elif self._acao_atual[0] == "esq":
            self.positionX = (self.positionX - 1) % WIDTH
        
        elif self._acao_atual[0] == "dir":
            self.positionX = (self.positionX + 1) % WIDTH
        
        elif self._acao_atual[0] == "parado":
            self.positionX += 0
            self.positionY += 0
        
        #diminue um passo
        self.passos_restantes -= 1
    
    def set_consequence(self):
      pass


# Loop de simulação
def simular_em_loop():
    for agent in agents:
        agent.previousPositionY = agent.positionY
        agent.previousPositionX = agent.positionX
        #context = agent.set_context()
        agent.to_respond(agent.antecedente_atual)
        agent.set_consequence()
    #time.sleep(1/PASSOS_POR_SEGUNDO)  # PASSOS_POR_SEGUNDO = 20, logo 50ms por passo

        `;
        await pyodide.runPythonAsync(code);

      } catch (err) {
        console.error("Erro ao rodar código Python:", err);
      }
      // Torna acessível no escopo global
      window.pyodide = pyodide;
    }

    init();

  </script>

  <script src="sketch.js"></script>
  <script src="apets.js"></script>
  
</body>
</html>