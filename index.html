<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>A-pets</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <main>
    <!-- Indicador de carregamento -->
    <div id="loading">
      <p>Carregando, por favor aguarde...</p>
    </div>

    <div id="main" style="display: none;">
      <div id="simContainer">
        <!-- O canvas será criado e inserido aqui pelo p5.js -->
      </div>
      
      <div id="customizacao">
        <label for="agentName">Nome do seu A-pet:</label>
        <input type="text" id="APetName" placeholder="Digite um nome">

        <label for="cor-corpo">Cor do corpo:</label>
        <input type="color" id="cor-corpo" name="cor-corpo" value="#d4a268">

        <label for="forma-corpo">Forma do corpo:</label>
        <select id="forma-corpo" name="forma-corpo">
        <option value="square">Quadrado</option>
        <option value="circle">Círculo</option>
        <option value="triangle">Triângulo</option>
        </select>

        <label for="cor-olhos">Cor dos olhos:</label>
        <input type="color" id="cor-olhos" name="cor-olhos" value="#6d3d1c">

        <label for="cor-boca">Cor da boca:</label>
        <input type="color" id="cor-boca" name="cor-boca" value="#bb5d5d">

        <br><br>
        <button onclick="criarAPet()">Criar</button>
      </div>

      <div id="controls" style="display: none;">
        <!-- Entrada de instrução -->
        <div id="instrucao">
          <label for="inputInstrucao" id="labelInputInstrucao">Instrução:</label>
          <input type="text" id="inputInstrucao" maxlength="50" placeholder="Digite uma instrução...">
          <button onclick="enviarInstrucao()">Enviar</button>
        </div>
        <!-- botões de reforçamento e punição -->
        <div id="botoesReP">
          <!-- tentar fazer usando codigo pyodide sincrono -->
          <!-- tentar fazer indicando no metodo consequence a quantidade de reforco -->
          <button onclick="reforcar()">Recompensa!</button>
          <button onclick="punir()">Punição!</button>
        </div>
      </div>
    </div>
  </main>

  <!-- Scripts externos: carregam primeiro -->
  <script src="https://cdn.jsdelivr.net/pyodide/v0.25.1/full/pyodide.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>

  <!-- Seu código -->
  <script>
    async function init() {
      const pyodide = await loadPyodide();
      await pyodide.loadPackage("micropip")

      try {
        const code = `
import micropip
await micropip.install("behavioralflow")
import time
from behavioralflow.core import Aprendente

PASSOS_POR_SEGUNDO = 20  # 1 segundo = 20 passos (com loop de 0.05s)

WIDTH = 400
HEIGHT = 400

responses = {("pular",):[0,6],
             ("pegar",):[0,1],
             ("esq",):[0,6],
             ("dir",):[0,6],
             ("entrar",):[0,1],
             ("parado",):[0,6]}

class Agents(Aprendente):
    def __init__(self, acoes, variar=False, prob_variacao=0.25, positionX = 0, positionY = 0, color="#000000", name = "", shape = "square", eyeColor="black", mouthColor="black"):
        super().__init__(acoes, variar, prob_variacao)
        self.positionX = positionX
        self.positionY = positionY
        self.passos_restantes = 0
        self.color = color
        self.name = name
        self.antecedente_atual = ("sem contexto",)
        self.shape = shape
        self.eyeColor = eyeColor
        self.mouthColor = mouthColor
        self.size = 60
        self.mouthType = "flat"
        self.eyeType = "round"
        self.xp = 0
        self.consequence = 0
    
    #def set_context(self):
        #context = ("sem contexto",)
        #return context
    
    # Tentar executar as açoes
    def to_respond(self, context):

        print(self._acao_atual[0])
        # Executa a ação atual
        if self._acao_atual[0] == "pular":
          if self.passos_restantes > (PASSOS_POR_SEGUNDO + (PASSOS_POR_SEGUNDO/2))/2: # 1seg e meio por ação
            self.positionY = (self.positionY - 1) % HEIGHT
          else:
            self.positionY = (self.positionY + 1) % HEIGHT
            #print(PASSOS_POR_SEGUNDO + (PASSOS_POR_SEGUNDO/2)/2)
        
        if self._acao_atual[0] == "esq":
          self.positionX = (self.positionX - 1) % WIDTH
        if self._acao_atual[0] == "dir":
          self.positionX = (self.positionX + 1) % WIDTH
        if self._acao_atual[0] == "parado":
          pass
        
        if self._acao_atual[0] == "entrar": #NÃO FICOU LEGAL PQ SÓ DIMINUI O CORPO E NÃO DIMINUI O ROSTO
          if self.passos_restantes > (PASSOS_POR_SEGUNDO + (PASSOS_POR_SEGUNDO/2))/2:
            self.size -= 1
          else:
            self.size += 1
    
    def set_consequence(self):
      if self.consequence != 0:
        self.reforcar(self.consequence)


# Loop de simulação
def simular_em_loop():
  if agentAPet.passos_restantes == 0:
      agentAPet.set_consequence()
      agentAPet.consequence = 0
      # INICIA NOVO CICLO DE COMPORTAMENTO ABAIXO
      agentAPet.mouthType = "flat"
      #context = agentAPet.set_context()
      agentAPet.proxima_acao(agentAPet.antecedente_atual)
      agentAPet.passos_restantes = PASSOS_POR_SEGUNDO + (PASSOS_POR_SEGUNDO/2) # 1seg e meio por ação

  agentAPet.to_respond(agentAPet.antecedente_atual)

  #diminue um passo
  agentAPet.passos_restantes -= 1
        `;
        await pyodide.runPythonAsync(code);

      } catch (err) {
        console.error("Erro ao rodar código Python:", err);
      }
      // Torna acessível no escopo global
      window.pyodide = pyodide;

      // Tudo carregado — esconder "Carregando..." e mostrar botão de iniciar
      document.getElementById("loading").style.display = "none";
      document.getElementById("main").style.display = "block";
    }

    init();

  </script>

  <script src="sketch.js"></script>
  <script src="apets.js"></script>
  
</body>
</html>